<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
  <style>
  </style>
</head>
<body style="background: lightblue;">
  <gamepad-display></gamepad-display>
  <!-- <div style="font-size: 10vh">
    a: <span class="a"></span><br/>
    b: <span class="b"></span><br/>
    x: <span class="x"></span><br/>
    y: <span class="y"></span><br/>
  </div> -->
  <thumbstick-input id="thumb1"></thumbstick-input>
  <button-cluster-input></button-cluster-input>
  <div id="extras" style="font-size: 2vw; font-family: sans">
  </div>

  <script type="module">
    import './thumbstick.js';
    import './button_cluster.js';
    import './gamepad_display.js';
    const virtual_gamepad = {};

    {
      const gamepad = virtual_gamepad;
      const display = document.querySelector('gamepad-display');
      const $extras = document.querySelector('#extras');
      let lastTimestamp = 0;
      const updateDisplay = () => {
        //const gamepad = navigator.getGamepads()[0];
        const timestamp = gamepad?.timestamp;
        if (timestamp != lastTimestamp) {
          const extras = display.updateState(gamepad) || [];
          $extras.innerHTML = extras.map(e => e.join(': ')).join('<br/>');
          lastTimestamp = timestamp;
        }
        requestAnimationFrame(updateDisplay);
      }
      updateDisplay();
    }
 
    // // value getter for axes, dispatch InputEvent when it changes
    // const a = document.querySelector('.a');
    // const b = document.querySelector('.b');
    // const x = document.querySelector('.x');
    // const y = document.querySelector('.y');
    {
      const gamepad = virtual_gamepad;
      const input = document.querySelector('button-cluster-input');
      const updateDisplay = () => {
        gamepad.buttons = input.value.map((value) => ({
          pressed: value > .1,
          touched: value > 0,
          value
        }));
        gamepad.connected = true;
        gamepad.timestamp = performance.now();
      };

      input.addEventListener('input', updateDisplay);
      updateDisplay();
    }


    // // value getter for axes, dispatch InputEvent when it changes
    // const x = document.querySelector('.x');
    // const y = document.querySelector('.y');
    {
      const gamepad = virtual_gamepad;
      const input = document.querySelector('thumbstick-input');
      const updateDisplay = () => {
        gamepad.axes = input.value;
        gamepad.connected = true;
        gamepad.timestamp = performance.now();
      };

      input.addEventListener('input', updateDisplay);
      updateDisplay();
    }

    // // Doesn't work unless HTTPS?
    // const accelX = document.querySelector('.x');
    // const accelY = document.querySelector('.y');
    // const accelZ = document.querySelector('.z');
    // window.addEventListener('devicemotion', (e) => {
    //   console.log(e);
    //   accelX.textContent = e.accelerationIncludingGravity.x;
    //   accelY.textContent = e.accelerationIncludingGravity.y;
    //   accelZ.textContent = e.accelerationIncludingGravity.z;
    // }, true);
    
    // for full gamepad:
    // if navigator.maxTouchPoints <= 1,
    // alert user that they won't have a great experience
    // detect portrait vs landscape prompt user to rotate device
    // offer to go fullscreen
    // request no sleep
    // input.meta.url query params to configure

    // Need better support for pressing two buttons at once with one thumb.
    // Right now it only checks the midpoint.
    // The width/height that pointer events gives us might not be good enough.

    // // for mapping to onscreen controls:
    // // from https://stackoverflow.com/a/36144688
    // function click(x, y) {
    //   document.elementFromPoint(x, y).dispatchEvent(
    //     new MouseEvent('click', {
    //       view: window,
    //       bubbles: true,
    //       cancelable: true,
    //       screenX: x,
    //       screenY: y
    //     })
    //   );
    // }
  </script>
</body>
</html>
